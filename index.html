<!DOCTYPE html>
<html lang="pt-br" ng-app="listaTelefonica">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Lista Telefônica</title>

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.css" />
    <style>
      .jumbotron {
        width: 600px;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
        background-color: rgba(0, 0, 0, 0.05);
        padding: 20px;
      }

      h3 {
        margin-bottom: 15px;
      }

      .table {
        margin-top: 20px;
      }

      .form-control,
      .form-select {
        margin-bottom: 8px;
      }

      .btn {
        margin-top: 15px;
      }

      .selecionado {
        font-weight: 700;
      }

      .card {
        background-color: rgba(0, 0, 0, 0.05);
        margin: 50px 0 0 0;
        border-radius: 0;
        padding: 20px;
      }

      a {
        color: inherit;
      }

      .alert {
        margin-top: 15px;
        margin-bottom: 0;
      }
    </style>
    <!-- Style -->

    <!-- Controller -->
    <script src="lib/angular/angular.js"></script>
    <script>
      const app = angular.module("listaTelefonica", []);

      app.controller("listaTelefonicaCtrl", function ($scope, $http) {
        $scope.app = "Lista Telefônica";

        // Comunicação com o back-end
        // Get
        const carregarContatos = function () {
          $http.get("https://67a9e52965ab088ea7e4e052.mockapi.io/api/contacts").then(function (data) {
            $scope.contatos = data.data;
          });
        };

        const carregarOperadoras = function () {
          $http.get("https://67a9e52965ab088ea7e4e052.mockapi.io/api/operadoras").then(function (data) {
            $scope.operadoras = data.data;
          });
        };

        carregarContatos();
        carregarOperadoras();
        // Get

        // Post
        $scope.adicionarContato = function (contato) {
          $http.post("https://67a9e52965ab088ea7e4e052.mockapi.io/api/contacts", contato).then(function (data) {
            delete $scope.contato;

            $scope.contatoForm.$setPristine();

            carregarContatos();
          });
        };
        // Post

        //Delete
        $scope.excluirContatos = function (contatos) {
          for (let i = 0; i < contatos.length; i++) {
            const contato = contatos[i];

            if (contato.selecionado) {
              $http
                .delete(`https://67a9e52965ab088ea7e4e052.mockapi.io/api/contacts/${contato.id}`)
                .then(function (data) {
                  carregarContatos();
                });
            }
          }
        };
        //Delete
        // Comunicação com o back-end

        // Funções Extras
        $scope.isContatoSelecionado = function (contatos) {
          return contatos.some(function (contato) {
            return contato.selecionado;
          });
        };

        $scope.ordernarPor = function (campo) {
          $scope.criterioDeOrdenacao = campo;

          $scope.direcaoDaOrdenacao = !$scope.direcaoDaOrdenacao;
        };
        // Funções Extras
      });
    </script>
    <!-- Controller -->
  </head>

  <!-- View -->
  <body ng-controller="listaTelefonicaCtrl">
    <!-- Lista Telefônica -->
    <div class="jumbotron">
      <h3>{{app}}</h3>

      <!-- Campo de busca -->
      <input class="form-control" type="text" ng-model="criterioDeBusca" placeholder="O que você está buscando?" />
      <!-- Campo de busca -->

      <!-- Lista de contatos -->
      <table class="table table-striped" ng-show="contatos.length > 0">
        <tr ng-init="ordernarPor('nome')">
          <th></th>
          <th><a href="" ng-click="ordernarPor('nome')">Nome</a></th>
          <th><a href="" ng-click="ordernarPor('telefone')">Telefone</a></th>
          <th><a href="" ng-click="ordernarPor('operadora')">Operadora</a></th>
        </tr>
        <tr
          ng-class="{selecionado: contato.selecionado}"
          ng-repeat="contato in contatos | filter:criterioDeBusca | orderBy:criterioDeOrdenacao:direcaoDaOrdenacao"
        >
          <td><input class="pointer" role="button" type="checkbox" ng-model="contato.selecionado" /></td>
          <td>{{contato.nome | uppercase | limitTo: 15}}</td>
          <td>{{contato.telefone}}</td>
          <td>{{contato.operadora.nome}}</td>
        </tr>
      </table>
      <!-- Lista de contatos -->

      <hr />

      <!-- Inserir contato -->
      <form name="contatoForm">
        <input name="nome" class="form-control" type="text" ng-model="contato.nome" placeholder="Nome" required />
        <input
          name="telefone"
          class="form-control"
          type="tel"
          pattern="[0-9]{2} [0-9]{5}-[0-9]{4}"
          ng-model="contato.telefone"
          placeholder="Tel.: XX XXXXX-XXXX"
          required
        />
        <select
          name="operadora"
          class="form-select"
          role="button"
          ng-model="contato.operadora"
          ng-options="operadora.nome group by operadora.categoria for operadora in operadoras | orderBy:'nome' "
          required
        >
          <option value="">Selecione uma operadora</option>
        </select>

        <!-- Mensagens de alerta -->
        <div ng-show="contatoForm.nome.$error.required && contatoForm.nome.$dirty" class="alert alert-danger">
          Por favor, preencha o campo nome!
        </div>

        <div ng-show="contatoForm.telefone.$error.required && contatoForm.telefone.$dirty" class="alert alert-danger">
          Por favor, preencha o campo telefone!
        </div>
        <div ng-show="contatoForm.telefone.$error.pattern" class="alert alert-danger">
          O campo telefone deve ter o formato "XX XXXXX-XXXX"
        </div>

        <div ng-show="contatoForm.operadora.$invalid && contatoForm.operadora.$dirty" class="alert alert-danger">
          Por favor, preencha o campo operadora!
        </div>
        <!-- Mensagens de alerta -->

        <div class="d-grid">
          <button class="btn btn-primary" ng-click="adicionarContato(contato)" ng-disabled="contatoForm.$invalid">
            Adicionar Contato
          </button>
        </div>
      </form>
      <!-- Inserir contato -->

      <!-- Excluir contatos -->
      <div class="d-grid">
        <button
          class="btn btn-danger"
          ng-click="excluirContatos(contatos)"
          ng-disabled="!isContatoSelecionado(contatos)"
          ng-show="isContatoSelecionado(contatos)"
        >
          Excluir Selecionados
        </button>
      </div>
      <!-- Excluir contatos -->
    </div>
    <!-- Lista Telefônica -->

    <!-- Footer -->
    <div ng-include=" 'footer.html' "></div>
    <!-- Footer -->
  </body>
  <!-- View -->
</html>
